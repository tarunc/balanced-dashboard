////
// balanced.js
// version: 1.1.17
// built: 2014-03-14
// https://github.com/balanced/balanced-js
////

!function(a,b){function c(a){a.meta||(a.meta={}),n.submitted=1*new Date,n.scrollX=window.scrollX,n.scrollY=window.scrollY;for(var b in n)"capabilities_"+b in a.meta||(a.meta["capabilities_"+b]=n[b]);return a}function d(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&(a["e"+b+c]=c,a[b+c]=function(){a["e"+b+c](window.event)},a.attachEvent("on"+b,a[b+c]))}function e(a){a=a?a:window.event;var b=!1;return a.shiftKey?b=a.shiftKey:a.modifiers&&(b=!!(4&a.modifiers)),b&&(r=!0),r}function f(a){if(null==a)return!0;for(var b in a)if(hasOwnProperty.call(a,b))return!1;return!0}function g(a,b){var c={},d={};if("object"==typeof a)for(var e=0;e<a.length;e++)d[a[e]]=b;else d[a]=b;return c.description=b,c.extras=d,c}function h(a,b,c){for(var d=0;d<a.length;d++){var e=a[d];b&&e in b&&b[e]||c.push(g(e,"Invalid field ["+e+'] - Missing field "'+e+'"'))}}function i(a,b,c){var d=[];h(b,a,d);var e=c(a);d=d.concat(e);for(var f=0;f<d.length;f++)d[f].status="Bad Request",d[f].category_code="request",d[f].additional=null,d[f].status_code=400,d[f].category_type="request";return d}function j(a,b){var c=b?b:"No data supplied";if(!a)throw c;a({errors:[{description:c,status:"Bad Request",category_code:"request",additional:null,status_code:400,category_type:"request",extras:{}}]})}function k(a,b){var c="balanced_jsonp_"+Math.random().toString().substr(2),d=document.createElement("script");d.type="text/javascript",d.async=!0,d.src=a.replace("{callback}",c);var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(d,e),window[c]=function(a){try{b(a)}catch(c){"undefined"!=typeof console&&console.error&&console.error(c)}d.parentNode.removeChild(d)}}function l(a,b){return q+a+"?callback={callback}&data="+encodeURI(JSON.stringify(b))}function m(a){function b(b){if(!c){if(c=!0,!b||!b.status)return void a({errors:[{description:"Unable to connect to the balanced servers",status:"Internal Server Error",category_code:"server-error",additional:null,status_code:500,category_type:"server-error",extras:{}}],status_code:500});var d=JSON.parse(b.body);"undefined"!=typeof b.status&&(d.status_code=b.status),a(d)}}var c=!1;return setTimeout(b,6e4),b}b.balanced=a;var n={system_timezone:-(new Date).getTimezoneOffset()/60,user_agent:navigator.userAgent,language:navigator.userLanguage||navigator.language,kp:0,cli:0,loaded:1*new Date,screen_width:screen.width,screen_length:screen.height,hist:window.history.length,cookie:function(){var a=document.cookie.match(/__b=([a-zA-Z0-9\-!\.]+)/);a=a?a[1]:1*new Date+"."+Math.random().toString().substr(2)+".0!0",a=a.split("!");var b=a[0].split(".");b.length<3&&(b[1]=Math.random().toString().substr(2),b[2]=0),b[2]++,a=b.join(".")+"!"+a[1];var c=new Date;return c.setDate(c.getDate()+365),document.cookie="__b="+a+" ;expires="+c.toUTCString(),a}()},o=null,p=null,q="https://api.balancedpayments.com",r=!1;d(window,"keydown",function(a){n.cl||(n.cl=e(a)),n.kp++}),d(window,"paste",function(){n.ps=!0}),d(window,"click",function(){n.cli++}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var s={isCardNumberValid:function(a){if(!a)return!1;if(a=(a+"").replace(/\D+/g,"").split("").reverse(),!a.length||a.length<12)return!1;var b,c=0;for(b=0;b<a.length;b++)a[b]=parseInt(a[b],10),c+=b%2?2*a[b]-(a[b]>4?9:0):a[b];return c%10===0},cardType:function(a){var b={};if(b[51]=b[52]=b[53]=b[54]=b[55]="Mastercard",b[34]=b[37]="American Express",b[4]="VISA",b[6]="Discover Card",b[35]="JCB",b[30]=b[36]=b[38]="Diners Club",a){a=a.toString().trim();for(var c in b)if(0===a.indexOf(c))return b[c]}return null},isCVVValid:function(a,b){var c=s.cardType(a);if(!c)return!1;var d="American Express"===c?4:3;return"string"!=typeof b&&"number"!=typeof b||b.toString().replace(/\D+/g,"").length!==d?!1:!0},isSecurityCodeValid:function(a,b){return s.isCVVValid(a,b)},isExpiryValid:function(a,b){if(!a||!b)return!1;if(a=parseInt(a,10),b=parseInt(b,10),isNaN(a)||isNaN(b)||a>12||1>a)return!1;var c=new Date;return!(c.getFullYear()>b||c.getFullYear()===b&&c.getMonth()>=a)},validate:function(a){a.number&&(a.number=a.number.toString().trim());var b=a.number,c=a.cvv,d=a.expiration_month,e=a.expiration_year,f=[];return s.isCardNumberValid(b)||f.push(g("number",'Invalid field [number] - "'+b+'" is not a valid credit card number')),"undefined"==typeof c||null===c||s.isCVVValid(b,c)||f.push(g("cvv",'Invalid field [cvv] - "'+c+'" is not a valid credit card security code')),s.isExpiryValid(d,e)||f.push(g(["expiration_month","expiration_year"],'Invalid field [expiration_month,expiration_year] - "'+d+"-"+e+'" is not a valid credit card expiration date')),f},create:function(a,b){if(!a)return void j(b);var d=["number","expiration_month","expiration_year"],e=i(a,d,s.validate);f(e)?k(l("/jsonp/cards",c(a)),m(b)):b({errors:e})}},t={validate:function(a){return a&&a.match(/[a-z0-9!#$%&'*+\/=?\^_`{|}~\-]+(?:\.[a-z0-9!#$%&'*+\/=?\^_`{|}~\-]+)*@(?:[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?/i)?!0:!1}},u={types:["savings","checking"],validate:function(a){var b="routing_number"in a?"routing_number":"bank_code",c=a[b],d=[];u.isRoutingNumberValid(c)||d.push(g(b,"Invalid field ["+b+'] - "'+c+'" is not a valid '+b.replace("_"," ")));var e=a.type||a.account_type,f="type"in a?"type":"account_type";return a[f]&&!u.validateType(e)&&d.push(g(f,"Invalid field ["+f+'] - "'+e+'" must be one of: "'+u.types.join('", "')+'"')),d},isRoutingNumberValid:function(a){if(!a)return!1;if(a=a.toString().match(/\d+/g),!a)return!1;if(a=a.join(""),!a||9!==a.length)return!1;for(var b=a.toString().split(""),c=[],d=0;d<b.length;d++)c.push(parseInt(b[d],10));return c[8]===(7*(c[0]+c[3]+c[6])+3*(c[1]+c[4]+c[7])+9*(c[2]+c[5]))%10},validateRoutingNumber:function(a){return u.isRoutingNumberValid(a)},lookupRoutingNumber:function(a,b){if(!a)return void j(b);var c="/bank_accounts/routing_numbers/"+a;k(l(c,null,m(b)))},validateType:function(a){return a?u.types.indexOf(a)>=0:!0},create:function(a,b){if(!a)return void j(b);var d=["name","account_number","routing_number"],e=i(a,d,u.validate);f(e)?("type"in a&&!1 in a&&(a.account_type=a.type),k(l("/jsonp/bank_accounts",c(a)),m(b))):b({errors:e})}},v={providers:{coinbase:{url:"https://coinbase.com/oauth/authorize",params:{response_type:"code",client_id:"050f4c85231a51c147a3fb011e012755d81cdb499cc50b5354b7bcdf9bf805ad",redirect_uri:"https://js.balancedpayments.com/callback.html",scope:"send"}}},provider_name:null,callback:null,create:function(a,b){var c=v.providers[a],d=c.url,e=c.params,f=[];if(v.provider_name=a,v.callback=b,e){for(var g in e)f.push(g+"="+e[g]);d=d+"?"+f.join("&")}p=window.open(d,"","top="+(window.outerHeight/2-275)+", left="+(window.outerWidth/2-250)+", width=500, height=550")},configure:function(){}};d(window,"message",function(a){if("https://js.balancedpayments.com"===a.origin){if(!a.data)return void j(v.callback);var b=a.data;b.token=a.data.token||a.data.code,b.provider=v.provider_name,k(l("/jsonp/external_accounts",b),m(v.callback)),p&&p.close()}}),"object"!=typeof JSON&&k("https://js.balancedpayments.com/json2.js");b.balanced={card:s,bankAccount:u,externalAccount:v,emailAddress:t,init:function(a){"string"==typeof a?o=a:(a&&"server"in a&&(q=a.server),a&&"marketplace_href"in a&&(o=a.marketplace_href),a&&"providers"in a&&(v.providers=a.providers))}}}({},function(){return this}());